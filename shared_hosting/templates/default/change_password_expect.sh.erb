#!/usr/bin/expect -f
# This script uses expect to log in as the specified user and change their password

set username [lindex $argv 0]
set current_password [lindex $argv 1]
set new_password [lindex $argv 2]
set prompt "\[>%\\$#\] "
log_user 0

send_user "\n"
spawn su $username

expect {
	"Password:" {
		send "$current_password\n"
		expect {
			-re "$prompt" {
				send "passwd\n"
				expect {
					"(current) UNIX password:" {
						send "$current_password\n" 
						expect {
							"Enter new UNIX password:" {
								send "$new_password\n" 
								expect {
									"Retype new UNIX password:" {
										send "$new_password\n" 
										expect {
											-re "$prompt" {
												send_user "Password updated successfully.\n\n"
												exit 0
											}
											"longer password" {
												send_user "The password you entered is too short. Please try again.\n\n"
												exit 0												
											}
											default {
												send_user "Password update failed.\n\n"
												exit 1
											}
										}
									}
									default {
										send_user "Password update failed.\n\n"
										exit 1
									}
								}
							}
							default {
								send_user "Password update failed.\n\n"
								exit 1
							}
						}
					}
					default {
						send_user "Password update failed.\n\n"
						exit 1
					}
				}
			}
			default {
				send_user "Password update failed.\n\n"
				exit 1
			}
		}
	}
	default {
		send_user "Password update failed.\n\n"
		exit 1
	}
}